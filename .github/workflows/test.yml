name: Test mitmproxy-logger-action

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Start mitmproxy
        id: mitmproxy
        uses: ./
        with:
          enabled: true
          listen-host: '127.0.0.1'
          listen-port: '8080'
          passphrase: 'test-passphrase-123'
      
      - name: Test proxy is running
        run: |
          echo "Proxy URL: ${{ steps.mitmproxy.outputs.proxy-url }}"
          echo "Traffic file: ${{ steps.mitmproxy.outputs.traffic-file }}"
          
          # Test if the proxy is responding
          curl -x ${{ steps.mitmproxy.outputs.proxy-url }} --max-time 10 http://httpbin.org/get || true
          
          # Give some time for traffic to be logged
          sleep 2
          
          # The action automatically stops mitmproxy and uploads artifacts in the post phase